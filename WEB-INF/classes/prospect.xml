<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.alaska.dggs.igneous.Prospect">
	<select id="getByID" resultSetType="FORWARD_ONLY" parameterType="int" resultMap="ProspectMap">
		SELECT prospect_id, name, alt_names, ardf_number
		FROM prospect
		WHERE prospect_id = #{id}
	</select>

	<resultMap id="ProspectMap" type="Prospect">
		<id property="id" column="prospect_id" />

		<result property="name" column="name" />
		<result property="alt_names" column="alt_names" />
		<result property="ardf" column="ardf_number" />

		<collection property="boreholes" column="prospect_id" ofType="Borehole"
			javaType="List" select="gov.alaska.dggs.igneous.Borehole.getByProspectID" />
	</resultMap>


	<select id="getInventorySummary" resultSetType="FORWARD_ONLY" parameterType="long" resultType="HashMap">
		SELECT k.keyword_id, k.name AS keyword,
			COUNT(*) AS count
		FROM borehole AS b
		JOIN inventory_borehole AS ib ON ib.borehole_id = b.borehole_id
		JOIN inventory_keyword AS ik ON ik.inventory_id = ib.inventory_id
		JOIN keyword AS k ON k.keyword_id = ik.keyword_id
		WHERE b.prospect_id = #{prospect_id}
			AND k.keyword_id IN (
				SELECT keyword_id
				FROM keyword
				WHERE name = 'residues'
					OR keyword_group_id IN (
						SELECT keyword_group_id
						FROM keyword_group
						WHERE name = 'source' OR
							name = 'material'
					)
			)
		GROUP BY k.keyword_id, k.name
		ORDER BY k.name
	</select>


	<select id="getWKT" resultSetType="FORWARD_ONLY" parameterType="long" resultType="HashMap">
		SELECT bh.borehole_id, bh.name,
			ST_AsText(ST_Transform(bg.geog::GEOMETRY, 3857)) AS wkt
		FROM borehole AS bh
		JOIN borehole_geog AS bg ON bh.borehole_id = bg.borehole_id
		WHERE bh.prospect_id = #{id}
	</select>
</mapper>
