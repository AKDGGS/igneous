<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.alaska.dggs.igneous.Quality">
	<!-- 
		This file contains all the queries used to render
		reports for the quality assurance report. If the query
		is succesful, it should return no results. Each returned
		row represents a single error.

		For display purposes, all the reports listed here must return
		an "id" field, and a "desc" field. The contents of these fields
		are optional, and merely used to aide the user in tracking down
		the sources of problems. You may populate them with whatever you
		want.

		Each function here must have a corresponding count function, that
		returns the count as a total number of errors returned.

		The queries listed here must corrospond to the reported listed
		in QualityServlet.java found in the source directory.
	-->
	<sql id="MissingBranch">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_keyword AS ik
			JOIN keyword AS k
				ON ik.keyword_id = k.keyword_id
			WHERE k.keyword_group_id = (
				SELECT keyword_group_id
				FROM keyword_group
				WHERE name = 'branch'
			)
		)
	</sql>
	<select id="getMissingBranch" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingBranch" />
	</select>
	<select id="getMissingBranchCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingBranch" />) AS q
	</select>


	<sql id="MissingType">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_keyword AS ik
			JOIN keyword AS k
				ON ik.keyword_id = k.keyword_id
			WHERE k.keyword_group_id = (
				SELECT keyword_group_id
				FROM keyword_group
				WHERE name = 'type'
			)
		)
	</sql>
	<select id="getMissingType" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingType" />
	</select>
	<select id="getMissingTypeCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingType" />) AS q
	</select>


	<sql id="SeparatedBarcodes">
		SELECT barcode AS id,
			STRING_AGG(path_cache, ', ') AS desc
		FROM (
			SELECT DISTINCT COALESCE(iv.barcode, iv.alt_barcode) AS barcode,
				iv.container_id, co.path_cache
			FROM inventory AS iv
			JOIN container AS co
				ON co.container_id = iv.container_id
			WHERE (iv.barcode IS NOT NULL
				OR iv.alt_barcode IS NOT NULL)
				AND POSITION('MSLIDE' IN co.path_cache) = 0
		) AS q1
		GROUP BY barcode
		HAVING COUNT(DISTINCT container_id) &gt; 1
	</sql>
	<select id="getSeparatedBarcodes" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="SeparatedBarcodes" />
	</select>
	<select id="getSeparatedBarcodesCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="SeparatedBarcodes" />) AS q
	</select>


	<sql id="MissingMetadata">
		SELECT iv.inventory_id AS id, 
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.inventory_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_well
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_borehole
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_outcrop
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_shotpoint

			UNION ALL

			SELECT inventory_id
			FROM inventory_publication
		)
	</sql>
	<select id="getMissingMetadata" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingMetadata" />
	</select>
	<select id="getMissingMetadataCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingMetadata" />) AS q
	</select>


	<sql id="MissingMetadataNoBLM">
		SELECT iv.inventory_id AS id, 
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.inventory_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_well
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_borehole
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_outcrop
			
			UNION ALL
			
			SELECT inventory_id
			FROM inventory_shotpoint

			UNION ALL

			SELECT inventory_id
			FROM inventory_publication
		) AND iv.collection_id &lt;&gt; (
			SELECT collection_id
			FROM collection
			WHERE name = 'BLM'
			LIMIT 1
		)
	</sql>
	<select id="getMissingMetadataNoBLM" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingMetadataNoBLM" />
	</select>
	<select id="getMissingMetadataNoBLMCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingMetadataNoBLM" />) AS q
	</select>


	<sql id="MissingContainer">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.container_id IS NULL
	</sql>
	<select id="getMissingContainer" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingContainer" />
	</select>
	<select id="getMissingContainerCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingContainer" />) AS q
	</select>


	<sql id="BarcodeOverlap">
		SELECT REGEXP_REPLACE(barcode, 'GMC-{0,1}(\d+)', '\1') AS id, '' AS desc
		FROM inventory
		WHERE POSITION('-' IN barcode) &lt;&gt; 0

		INTERSECT

		SELECT REGEXP_REPLACE(barcode, 'GMC-{0,1}(\d+)', '\1') AS id, '' AS desc
		FROM inventory
		WHERE POSITION('-' IN barcode) = 0
	</sql>
	<select id="getBarcodeOverlap" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="BarcodeOverlap" />
	</select>
	<select id="getBarcodeOverlapCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="BarcodeOverlap" />) AS q
	</select>


	<sql id="WellNumberEmpty">
		SELECT well_id AS id, name AS desc
		FROM well
		WHERE well_number IS NULL
			OR LENGTH(TRIM(BOTH FROM well_number)) = 0
	</sql>
	<select id="getWellNumberEmpty" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="WellNumberEmpty" />
	</select>
	<select id="getWellNumberEmptyCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="WellNumberEmpty" />) AS q
	</select>


	<sql id="APIBadLength">
		SELECT well_id AS id, name AS desc
		FROM well
		WHERE api_number IS NOT NULL
			AND LENGTH(api_number) &lt;&gt; 14
	</sql>
	<select id="getAPIBadLength" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="APIBadLength" />
	</select>
	<select id="getAPIBadLengthCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="APIBadLength" />) AS q
	</select>


	<sql id="BottomOverTop">
		SELECT inventory_id AS id, COALESCE(barcode, alt_barcode) AS desc
		FROM inventory
		WHERE interval_top IS NOT NULL
			AND interval_bottom IS NOT NULL
			AND interval_bottom &lt; interval_top
	</sql>
	<select id="getBottomOverTop" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="BottomOverTop" />
	</select>
	<select id="getBottomOverTopCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="BottomOverTop" />) AS q
	</select>


	<sql id="WellNoSpatial">
		SELECT well_id AS id, name AS desc
		FROM well
		WHERE well_id NOT IN (
			SELECT well_id FROM well_geog
		)
	</sql>
	<select id="getWellNoSpatial" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="WellNoSpatial" />
	</select>
	<select id="getWellNoSpatialCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="WellNoSpatial" />) AS q
	</select>


	<sql id="BoreholeNoSpatial">
		SELECT borehole_id AS id, name AS desc
		FROM borehole
		WHERE borehole_id NOT IN (
			SELECT borehole_id FROM borehole_geog
		)
	</sql>
	<select id="getBoreholeNoSpatial" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="BoreholeNoSpatial" />
	</select>
	<select id="getBoreholeNoSpatialCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="BoreholeNoSpatial" />) AS q
	</select>


	<sql id="OutcropNoSpatial">
		SELECT outcrop_id AS id, name AS desc
		FROM outcrop
		WHERE outcrop_id NOT IN (
			SELECT outcrop_id FROM outcrop_geog
		)
	</sql>
	<select id="getOutcropNoSpatial" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="OutcropNoSpatial" />
	</select>
	<select id="getOutcropNoSpatialCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="OutcropNoSpatial" />) AS q
	</select>


	<sql id="ShotpointNoSpatial">
		SELECT shotpoint_id AS id, shotpoint_number AS desc
		FROM shotpoint
		WHERE shotpoint_id NOT IN (
			SELECT shotpoint_id FROM shotpoint_geog
		)
	</sql>
	<select id="getShotpointNoSpatial" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="ShotpointNoSpatial" />
	</select>
	<select id="getShotpointNoSpatialCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="ShotpointNoSpatial" />) AS q
	</select>


	<sql id="OutcropInventoryNoSampleNumber">
		SELECT io.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode) AS desc
		FROM inventory_outcrop AS io
		JOIN inventory AS iv ON iv.inventory_id = io.inventory_id
		WHERE iv.sample_number IS NULL
			OR LENGTH(TRIM(BOTH FROM iv.sample_number)) = 0
	</sql>
	<select id="getOutcropInventoryNoSampleNumber" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="OutcropInventoryNoSampleNumber" />
	</select>
	<select id="getOutcropInventoryNoSampleNumberCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="OutcropInventoryNoSampleNumber" />) AS q
	</select>


	<sql id="MissingBarcode">
		SELECT iv.inventory_id AS id, co.path_cache AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE LENGTH(TRIM(BOTH FROM COALESCE(iv.barcode, iv.alt_barcode, ''))) = 0
	</sql>
	<select id="getMissingBarcode" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="MissingBarcode" />
	</select>
	<select id="getMissingBarcodeCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="MissingBarcode" />) AS q
	</select>


	<sql id="InventoryDeeperThanWell">
		SELECT iw.inventory_id AS id,
			iv.interval_bottom || ' &gt; ' ||
			GREATEST(we.measured_depth, we.vertical_depth) AS desc
		FROM inventory_well AS iw
		JOIN inventory AS iv ON iv.inventory_id = iw.inventory_id
		JOIN well AS we ON we.well_id = iw.well_id
		WHERE iv.interval_bottom IS NOT NULL
			AND COALESCE(we.measured_depth, we.vertical_depth) IS NOT NULL
			AND GREATEST(we.measured_depth, we.vertical_depth) &lt; iv.interval_bottom 
		ORDER BY (
				iv.interval_bottom - GREATEST(we.measured_depth, we.vertical_depth)
			) DESC
	</sql>
	<select id="getInventoryDeeperThanWell" resultSetType="FORWARD_ONLY" resultType="HashMap">
		<include refid="InventoryDeeperThanWell" />
	</select>
	<select id="getInventoryDeeperThanWellCount" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT COUNT(*)
		FROM (<include refid="InventoryDeeperThanWell" />) AS q
	</select>
</mapper>
