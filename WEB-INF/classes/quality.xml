<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.alaska.dggs.igneous.Quality">
	<select id="getMissingBranch" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_keyword AS ik
			JOIN keyword AS k
				ON ik.keyword_id = k.keyword_id
			WHERE k.keyword_group_id = (
				SELECT keyword_group_id
				FROM keyword_group
				WHERE name = 'branch'
			)
		)
	</select>


	<select id="getMissingType" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_keyword AS ik
			JOIN keyword AS k
				ON ik.keyword_id = k.keyword_id
			WHERE k.keyword_group_id = (
				SELECT keyword_group_id
				FROM keyword_group
				WHERE name = 'type'
			)
		)
	</select>


	<select id="getSeparatedBarcodes" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT barcode AS id,
			STRING_AGG(path_cache, ', ') AS desc
		FROM (
			SELECT DISTINCT COALESCE(iv.barcode, iv.alt_barcode) AS barcode,
				iv.container_id, co.path_cache
			FROM inventory AS iv
			JOIN container AS co
				ON co.container_id = iv.container_id
			WHERE (iv.barcode IS NOT NULL
				OR iv.alt_barcode IS NOT NULL)
				AND POSITION('MSLIDE' IN co.path_cache) = 0
		) AS q1
		GROUP BY barcode
		HAVING COUNT(DISTINCT container_id) > 1
	</select>


	<select id="getMissingMetadata" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT iv.inventory_id AS id, 
			COALESCE(iv.barcode, iv.alt_barcode, '') || ' ' || COALESCE(co.path_cache, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.inventory_id
		WHERE iv.inventory_id NOT IN (
			SELECT inventory_id
			FROM inventory_well
			
			UNION
			
			SELECT inventory_id
			FROM inventory_borehole
			
			UNION
			
			SELECT inventory_id
			FROM inventory_outcrop
			
			UNION
			
			SELECT inventory_id
			FROM inventory_shotpoint
		)
	</select>


	<select id="getMissingContainer" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT iv.inventory_id AS id,
			COALESCE(iv.barcode, iv.alt_barcode, '') AS desc
		FROM inventory AS iv
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		WHERE iv.container_id IS NULL
	</select>


	<select id="getBarcodeOverlap" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT REGEXP_REPLACE(barcode, 'GMC-{0,1}(\d+)', '\1') AS id, '' AS desc
		FROM inventory WHERE POSITION('-' IN barcode) &lt;&gt; 0

		INTERSECT

		SELECT REGEXP_REPLACE(barcode, 'GMC-{0,1}(\d+)', '\1') AS id, '' AS desc
		FROM inventory WHERE POSITION('-' IN barcode) = 0
	</select>
</mapper>
