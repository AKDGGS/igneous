<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="gov.alaska.dggs.igneous.Borehole">
	<sql id="getBy">
		SELECT bh.borehole_id, bh.prospect_id,
			bh.name AS borehole_name,
			bh.alt_names AS alt_borehole_names,
			bh.is_onshore, bh.completion_date,
			
			bh.measured_depth, mdu.unit_id AS mdu_unit_id,
			mdu.abbr AS mdu_unit_abbr, mdu.name AS mdu_unit_name,

			bh.elevation, evu.unit_id AS evu_unit_id,
			evu.abbr AS evu_unit_abbr, evu.name AS evu_unit_name
	</sql>

	<select id="getByID" resultSetType="FORWARD_ONLY" parameterType="long" resultMap="BoreholeMap">
		<include refid="getBy" />
		FROM borehole AS bh
		LEFT OUTER JOIN unit AS mdu
			ON mdu.unit_id = measured_depth_unit_id
		LEFT OUTER JOIN unit AS evu
			ON evu.unit_id = elevation_unit_id
		WHERE bh.borehole_id = #{borehole_id}
	</select>

	<select id="getByProspectID" resultSetType="FORWARD_ONLY" parameterType="long" resultMap="BoreholeMap">
		<include refid="getBy" />
		FROM borehole AS bh
		LEFT OUTER JOIN unit AS mdu
			ON mdu.unit_id = measured_depth_unit_id
		LEFT OUTER JOIN unit AS evu
			ON evu.unit_id = elevation_unit_id
		WHERE bh.prospect_id = #{prospect_id}
		ORDER BY LOWER(bh.name)
	</select>

	<select id="getByInventoryID" resultSetType="FORWARD_ONLY" parameterType="long" resultMap="BoreholeMap">
		<include refid="getBy" />
		FROM inventory_borehole AS ib
		JOIN borehole AS bh
			ON bh.borehole_id = ib.borehole_id
		LEFT OUTER JOIN unit AS mdu
			ON mdu.unit_id = measured_depth_unit_id
		LEFT OUTER JOIN unit AS evu
			ON evu.unit_id = elevation_unit_id
		WHERE ib.inventory_id = #{inventory_id}
	</select>


	<resultMap id="BoreholeMap" type="Borehole">
		<id property="id" column="borehole_id" />

		<result property="name" column="borehole_name" />
		<result property="alt_names" column="alt_borehole_names" />
		<result property="is_onshore" column="is_onshore" />
		<result property="completion" column="completion_date" />

		<result property="measured_depth" column="measured_depth" />
		<result property="elevation" column="elevation" />

		<association property="measured_depth_unit" javaType="Unit">
			<id property="id" column="mdu_unit_id" />
			<result property="abbr" column="mdu_unit_abbr" />
			<result property="name" column="mdu_unit_name" />
		</association>

		<association property="elevation_unit" javaType="Unit">
			<id property="id" column="evu_unit_id" />
			<result property="abbr" column="evu_unit_abbr" />
			<result property="name" column="evu_unit_name" />
		</association>

		<association property="prospect" column="prospect_id" javaType="Prospect"
			select="gov.alaska.dggs.igneous.Prospect.getByID" />
	</resultMap>


	<select id="getInventorySummary" resultSetType="FORWARD_ONLY" parameterType="long" resultType="HashMap">
		SELECT k.keyword_id, k.name AS keyword, COUNT(*) AS count
		FROM inventory_borehole AS ib
		JOIN inventory_keyword AS ik
			ON ik.inventory_id = ib.inventory_id
		JOIN keyword AS k
			ON k.keyword_id = ik.keyword_id
		WHERE ib.borehole_id = #{borehole_id}
			AND k.keyword_id IN (
				SELECT keyword_id
				FROM keyword
				WHERE name = 'residues'
					OR keyword_group_id IN (
						SELECT keyword_group_id
						FROM keyword_group
						WHERE name = 'source' OR
							name = 'material'
					)
			)
		GROUP BY k.keyword_id, k.name
		ORDER BY k.name
	</select>


	<select id="getWKT" resultSetType="FORWARD_ONLY" parameterType="long" resultType="HashMap">
		SELECT ST_AsText(ST_Transform(geog::GEOMETRY, 3857)) AS wkt
		FROM borehole_geog
		WHERE borehole_id = #{id}
		LIMIT 1
	</select>


	<select id="getIDByWKT" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT DISTINCT borehole_id FROM borehole_geog
		WHERE ST_Intersects(geog, ST_Transform(ST_GeomFromText(#{wkt}, 3857), 4326))
	</select>
</mapper>
