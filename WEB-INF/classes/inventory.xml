<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gov.alaska.dggs.igneous.Inventory">
	<select id="getByBarcode" parameterType="String" resultSetType="FORWARD_ONLY" resultMap="ByBarcodeInventoryMap">
		SELECT iv.inventory_id, iv.sample_number,
			iv.barcode, iv.alt_barcode,
			iv.box_number, iv.set_number,
			iv.core_number, iv.state_number,
			iv.description, iv.remark,
			iv.interval_top, iv.interval_bottom,
			iv.keywords::text[],
			iun.unit_id AS interval_unit_id,
			iun.name AS interval_unit_name,
			iun.abbr AS interval_unit_abbr,
			cl.collection_id, cl.name AS collection_name,
			cl.description AS collection_description,
			co.path_cache AS container_path
		FROM inventory AS iv
		LEFT OUTER JOIN collection AS cl ON
			cl.collection_id = iv.collection_id
		LEFT OUTER JOIN unit AS iun ON
			iun.unit_id = iv.interval_unit_id
		LEFT OUTER JOIN container AS co ON
			co.container_id = iv.container_id
		WHERE iv.barcode = #{barcode}
			OR iv.barcode = ('GMC-' || #{barcode})
			OR iv.alt_barcode = #{barcode}
			OR iv.container_id IN (
				WITH RECURSIVE r AS (
					SELECT container_id
					FROM container WHERE barcode = #{barcode}

					UNION ALL

					SELECT co.container_id
					FROM r
					JOIN container AS co
						ON r.container_id = co.parent_container_id
				) SELECT container_id FROM r
			)
		LIMIT 100
	</select>


	<resultMap id="ByBarcodeInventoryMap" type="Inventory">
		<id property="id" column="inventory_id" />
		<result property="sample_number" column="sample_number" />
		<result property="barcode" column="barcode" />
		<result property="alt_barcode" column="alt_barcode" />
		<result property="box_number" column="box_number" />
		<result property="set_number" column="set_number" />
		<result property="core_number" column="core_number" />
		<result property="state_number" column="state_number" />
		<result property="description" column="description" />
		<result property="intervalTop" column="interval_top" />
		<result property="intervalBottom" column="interval_bottom" />
		<result property="remark" column="remark" />
		<result property="container_path" column="container_path" />
		<result property="keywords" column="keywords" typeHandler="org.apache.ibatis.type.ArrayTypeHandler" />

		<association property="interval_unit" javaType="Unit">
			<id property="id" column="interval_unit_id" />
			<result property="abbr" column="interval_unit_abbr" />
			<result property="name" column="interval_unit_name" />
		</association>

		<association property="collection" javaType="iCollection">
			<id property="id" column="collection_id" />
			<result property="name" column="collection_name" />
			<result property="description" column="collection_description" />
		</association>

		<collection property="wells" column="inventory_id" ofType="Well" select="gov.alaska.dggs.igneous.Well.getByInventoryID" />
		<collection property="boreholes" column="inventory_id" ofType="Borehole" select="gov.alaska.dggs.igneous.Borehole.getByInventoryID" />
		<collection property="outcrops" column="inventory_id" ofType="Outcrop" select="gov.alaska.dggs.igneous.Outcrop.getByInventoryID" />
		<collection property="files" column="inventory_id" ofType="File" select="gov.alaska.dggs.igneous.File.getByInventoryID" />
		<collection property="publications" column="inventory_id" ofType="Publication" select="gov.alaska.dggs.igneous.Publication.getByInventoryID" />
		<collection property="shotpoints" column="inventory_id" ofType="Shotpoint" select="gov.alaska.dggs.igneous.Shotpoint.getByInventoryID" />
	</resultMap>


	<select id="getByID" parameterType="int" resultSetType="FORWARD_ONLY" resultMap="InventoryMap">
		SELECT iv.inventory_id,
			iv.parent_id,

			cl.collection_id,
			cl.name AS collection_name,
			cl.description AS collection_description,

			co.container_id,
			co.name AS container_name,
			co.remark AS container_remark,
			co.barcode AS container_barcode,
			co.alt_barcode AS container_alt_barcode,
			co.path_cache AS container_path_cache,

			iv.dggs_sample_id,
			iv.sample_number,
			iv.sample_number_prefix,
			iv.alt_sample_number,
			iv.published_sample_number,
			iv.published_number_has_suffix,
			iv.barcode,
			iv.alt_barcode,
			iv.state_number,
			iv.box_number,
			iv.set_number,
			iv.split_number,
			iv.slide_number,
			iv.slip_number,
			iv.lab_number,
			iv.lab_report_id,
			iv.map_number,
			iv.description, 
			iv.remark,
			iv.tray,
			iv.interval_top,
			iv.interval_bottom,
			iv.keywords::text[],
			iun.unit_id AS interval_unit_id,
			iun.name AS interval_unit_name,
			iun.abbr AS interval_unit_abbr,
			iv.core_number,

			cd.core_diameter_id,
			cd.name AS core_diameter_name,
			cd.core_diameter,
			cdun.unit_id AS core_diameter_unit_id,
			cdun.name AS core_diameter_unit_name,
			cdun.abbr AS core_diameter_unit_abbr,

			iv.weight,
			wun.unit_id AS weight_unit_id,
			wun.name AS weight_unit_name,
			wun.abbr AS weight_unit_abbr,

			iv.sample_frequency,
			iv.recovery,
			iv.can_publish,
			iv.radiation_msvh,
			iv.received_date,
			iv.entered_date,

			iv.modified_date,
			iv.modified_user,

			iv.active
		FROM inventory AS iv
		LEFT OUTER JOIN collection AS cl
			ON cl.collection_id = iv.collection_id
		LEFT OUTER JOIN unit AS iun
			ON iun.unit_id = iv.interval_unit_id
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		LEFT OUTER JOIN core_diameter AS cd
			ON cd.core_diameter_id = iv.core_diameter_id
		LEFT OUTER JOIN unit AS cdun
			ON cdun.unit_id = cd.unit_id
		LEFT OUTER JOIN unit AS wun
			ON wun.unit_id = iv.weight_unit_id
		WHERE iv.inventory_id = #{id}
	</select>


	<resultMap id="InventoryMap" type="Inventory">
		<id property="id" column="inventory_id" />
		<result property="dggs_sample_id" column="dggs_sample_id" />
		<result property="sample_number" column="sample_number" />
		<result property="sample_number_prefix" column="sample_number_prefix" />
		<result property="alt_sample_number" column="alt_sample_number" />
		<result property="published_sample_number" column="published_sample_number" />
		<result property="published_number_has_suffix" column="published_number_has_suffix" />
		<result property="barcode" column="barcode" />
		<result property="alt_barcode" column="alt_barcode" />
		<result property="state_number" column="state_number" />
		<result property="box_number" column="box_number" />
		<result property="set_number" column="set_number" />
		<result property="split_number" column="split_number" />
		<result property="slide_number" column="slide_number" />
		<result property="slip_number" column="slip_number" />
		<result property="lab_number" column="lab_number" />
		<result property="lab_report_id" column="lab_report_id" />
		<result property="map_number" column="map_number" />
		<result property="description" column="description" />
		<result property="remark" column="remark" />
		<result property="tray" column="tray" />
		<result property="intervalTop" column="interval_top" />
		<result property="intervalBottom" column="interval_bottom" />
		<result property="core_number" column="core_number" />
		<result property="weight" column="weight" />
		<result property="sample_frequency" column="sample_frequency" />
		<result property="recovery" column="recovery" />
		<result property="can_publish" column="can_publish" />
		<result property="radiation_msvh" column="radiation_msvh" />
		<result property="received" column="received_date" />
		<result property="entered" column="entered_date" />
		<result property="modified" column="modified_date" />
		<result property="user" column="modified_user" />
		<result property="keywords" column="keywords" typeHandler="org.apache.ibatis.type.ArrayTypeHandler" />
		<result property="active" column="active" />

		<association property="interval_unit" javaType="Unit">
			<id property="id" column="interval_unit_id" />
			<result property="name" column="interval_unit_name" />
			<result property="abbr" column="interval_unit_abbr" />
		</association>

		<association property="core_diameter" javaType="CoreDiameter">
			<id property="id" column="core_diameter_id" />
			<result property="diameter" column="core_diameter" />
			<result property="name" column="core_diameter_name" />
			<association property="unit" javaType="Unit">
				<id property="id" column="core_diameter_unit_id" />
				<result property="name" column="core_diameter_unit_name" />
				<result property="abbr" column="core_diameter_unit_abbr" />
			</association>
		</association>

		<association property="weight_unit" javaType="Unit">
			<id property="id" column="weight_unit_id" />
			<result property="name" column="weight_unit_name" />
			<result property="abbr" column="weight_unit_abbr" />
		</association>

		<association property="collection" javaType="iCollection">
			<id property="id" column="collection_id" />
			<result property="name" column="collection_name" />
			<result property="description" column="collection_description" />
		</association>

		<association property="container" javaType="Container">
			<id property="id" column="container_id" />
			<result property="name" column="container_name" />
			<result property="remark" column="container_remark" />
			<result property="barcode" column="container_barcode" />
			<result property="alt_barcode" column="container_alt_barcode" />
			<result property="path_cache" column="container_path_cache" />
		</association>

		<collection property="wells" column="inventory_id" ofType="Well" select="gov.alaska.dggs.igneous.Well.getByInventoryID" />
		<collection property="boreholes" column="inventory_id" ofType="Borehole" select="gov.alaska.dggs.igneous.Borehole.getByInventoryID" />
		<collection property="outcrops" column="inventory_id" ofType="Outcrop" select="gov.alaska.dggs.igneous.Outcrop.getByInventoryID" />
		<collection property="files" column="inventory_id" ofType="File" select="gov.alaska.dggs.igneous.File.getByInventoryID" />
		<collection property="publications" column="inventory_id" ofType="Publication" select="gov.alaska.dggs.igneous.Publication.getByInventoryID" />
		<collection property="shotlines" column="inventory_id" ofType="Shotline" select="gov.alaska.dggs.igneous.Shotline.getByInventoryID" />
		<collection property="notes" column="inventory_id" ofType="Note" select="gov.alaska.dggs.igneous.Note.getByInventoryID" />
		<collection property="qualities" column="inventory_id" ofType="InventoryQuality" select="gov.alaska.dggs.igneous.InventoryQuality.getByInventoryID" />
		<collection property="containerlog" column="inventory_id" ofType="ContainerLog" select="gov.alaska.dggs.igneous.Container.getContainerLogByInventoryID" />
		<collection property="urls" column="inventory_id" ofType="URL" select="gov.alaska.dggs.igneous.URL.getByInventoryID" />
	</resultMap>


	<select id="getIDByWKT" resultSetType="FORWARD_ONLY" resultType="int">
		SELECT DISTINCT inventory_id FROM inventory_geog
		WHERE ST_Intersects(
			geog, ST_Transform(ST_GeomFromText(#{wkt}, 3857), 4326)
		) LIMIT ${limit}
	</select>


	<select id="getMultiIDByWKT" resultSetType="FORWARD_ONLY" resultType="HashMap">
		SELECT type, id
		FROM (
			SELECT DISTINCT 1 AS type, borehole_id AS id, geog
			FROM borehole_geog

			UNION ALL

			SELECT DISTINCT 2 AS type, well_id AS id, geog
			FROM well_geog

			UNION ALL

			SELECT DISTINCT 3 AS type, outcrop_id AS id, geog
			FROM outcrop_geog

			UNION ALL

			SELECT DISTINCT 4 AS type, shotline_id AS id, geog
			FROM shotline_geog
		) AS q
		WHERE ST_Intersects(geog, ST_Transform(ST_GeomFromText(#{wkt}, 3857), 4326))
		ORDER BY type, id
	</select>


	<select id="getSearchResults" resultSetType="FORWARD_ONLY" resultMap="SearchMap">
		SELECT iv.inventory_id, iv.sample_number,
			<if test="authenticated == true">
			iv.barcode, iv.alt_barcode,
			</if>
			iv.box_number, iv.set_number,
			iv.core_number, iv.state_number,
			iv.slide_number,
			iv.interval_top, iv.interval_bottom,
			iv.keywords::text[],
			iun.unit_id AS interval_unit_id,
			iun.name AS interval_unit_name,
			iun.abbr AS interval_unit_abbr,

			cl.collection_id, cl.name AS collection_name,

			pr.project_id, pr.name AS project_name,
			pr.start_date AS project_start_date,
			pr.end_date AS project_end_date,

			cd.core_diameter_id, cd.name AS core_diameter_name,
			cd.core_diameter AS core_diameter_diameter,
			cdun.unit_id AS core_diameter_unit_id,
			cdun.name AS core_diameter_unit_name,
			cdun.abbr AS core_diameter_unit_abbr,

			<if test="authenticated == true">
			co.path_cache AS container_path,
			</if>

			bh.borehole_id,
			bh.name AS borehole_name,
			bh.alt_names AS alt_borehole_names,

			ph.prospect_id,
			ph.name AS prospect_name,
			ph.alt_names AS alt_prospect_names,
			ph.ardf_number,

			w.well_id, 
			w.name AS well_name,
			w.alt_names AS alt_well_names,
			w.well_number, w.api_number,

			o.outcrop_id,
			o.name AS outcrop_name,
			o.outcrop_number,

			sl.shotline_id,
			sl.name AS shotline_name,
			sl.alt_names AS alt_shotline_names,
			sl.year AS shotline_year,
			ismm.shotline_min,
			ismm.shotline_max,

			<if test="expand == true">
			iv.description,
			iv.remark,
			</if>

			<if test="authenticated == true">
			qu.inventory_quality_id,
			qu.check_date AS quality_check_date,
			qu.username AS quality_username,
			qu.remark AS quality_remark,
			qu.issues::text[] AS quality_issues,
			</if>

			ST_AsGeoJSON(ig.geog, 5, 0) AS geojson,
			longitude,
			latitude
		FROM inventory AS iv
		JOIN inventory_search AS ig
			ON ig.inventory_id = iv.inventory_id
		<if test="authenticated == true">
		LEFT OUTER JOIN inventory_quality AS qu
			ON qu.inventory_quality_id = ig.inventory_quality_id
		</if>
		LEFT OUTER JOIN collection AS cl
			ON cl.collection_id = iv.collection_id
		LEFT OUTER JOIN unit AS iun
			ON iun.unit_id = iv.interval_unit_id
		LEFT OUTER JOIN project AS pr
			ON pr.project_id = iv.project_id
		<if test="authenticated == true">
		LEFT OUTER JOIN container AS co
			ON co.container_id = iv.container_id
		</if>
		LEFT OUTER JOIN inventory_borehole AS ibh
			ON ibh.inventory_id = iv.inventory_id
		LEFT OUTER JOIN borehole AS bh
			ON bh.borehole_id = ibh.borehole_id
		LEFT OUTER JOIN prospect AS ph
			ON ph.prospect_id = bh.prospect_id
		LEFT OUTER JOIN core_diameter AS cd
			ON cd.core_diameter_id = iv.core_diameter_id
		LEFT OUTER JOIN unit AS cdun
			ON cdun.unit_id = cd.unit_id
		LEFT OUTER JOIN inventory_well AS iw
			ON iw.inventory_id = iv.inventory_id
		LEFT OUTER JOIN well AS w
			ON w.well_id = iw.well_id
		LEFT OUTER JOIN inventory_outcrop AS io
			ON io.inventory_id = iv.inventory_id
		LEFT OUTER JOIN outcrop AS o
			ON o.outcrop_id = io.outcrop_id
		LEFT OUTER JOIN inventory_shotline AS isl
			ON isl.inventory_id = iv.inventory_id
		LEFT OUTER JOIN shotline AS sl
			ON sl.shotline_id = isl.shotline_id
		LEFT OUTER JOIN inventory_shotline_minmax AS ismm
			ON ismm.inventory_id = iv.inventory_id
			AND ismm.shotline_id = isl.shotline_id
		WHERE iv.inventory_id IN <foreach item="item" index="index" collection="list" open="(" separator="," close=")">${item}</foreach>
		ORDER BY idx(<foreach item="item" index="index" open="ARRAY[" separator="," collection="list" close="]">${item}</foreach>, iv.inventory_id)
	</select>


	<resultMap id="SearchMap" type="Inventory">
		<id property="id" column="inventory_id" />
		<result property="sample_number" column="sample_number" />
		<result property="description" column="description" />
		<result property="remark" column="remark" />
		<result property="barcode" column="barcode" />
		<result property="alt_barcode" column="alt_barcode" />
		<result property="container_path" column="container_path" />
		<result property="box_number" column="box_number" />
		<result property="set_number" column="set_number" />
		<result property="slide_number" column="slide_number" />
		<result property="core_number" column="core_number" />
		<result property="state_number" column="state_number" />
		<result property="intervalTop" column="interval_top" />
		<result property="intervalBottom" column="interval_bottom" />
		<result property="geojson" column="geojson" />
		<result property="longitude" column="longitude" />
		<result property="latitude" column="latitude" />
		<result property="keywords" column="keywords" typeHandler="org.apache.ibatis.type.ArrayTypeHandler" />

		<association property="interval_unit" javaType="Unit">
			<id property="id" column="interval_unit_id" />
			<result property="abbr" column="interval_unit_abbr" />
			<result property="name" column="interval_unit_name" />
		</association>

		<association property="core_diameter" javaType="CoreDiameter">
			<id property="id" column="core_diameter_id" />
			<result property="name" column="core_diameter_name" />
			<result property="diameter" column="core_diameter_diameter" />

			<association property="unit" javaType="Unit">
				<id property="id" column="core_diameter_unit_id" />
				<result property="name" column="core_diameter_unit_name" />
				<result property="abbr" column="core_diameter_unit_abbr" />
			</association>
		</association>

		<association property="collection" javaType="iCollection">
			<id property="id" column="collection_id" />
			<result property="name" column="collection_name" />
		</association>

		<association property="project" javaType="Project">
			<id property="id" column="project_id" />
			<result property="name" column="project_name" />
			<result property="start_date" column="project_start_date" />
			<result property="end_date" column="project_end_date" />
		</association>

		<collection property="boreholes" ofType="Borehole">
			<id property="id" column="borehole_id" />
			<result property="name" column="borehole_name" />
			<result property="alt_names" column="alt_borehole_names" />

			<association property="prospect" javaType="Prospect">
				<id property="id" column="prospect_id" />
				<result property="name" column="prospect_name" />
				<result property="alt_names" column="alt_prospect_names" />
				<result property="ardf" column="ardf_number" />
			</association>
		</collection>

		<collection property="wells" ofType="Well">
			<id property="id" column="well_id" />
			<result property="name" column="well_name" />
			<result property="alt_names" column="alt_well_names" />
			<result property="well_number" column="well_number" />
			<result property="api_number" column="api_number" />
		</collection>

		<collection property="outcrops" ofType="Outcrop">
			<id property="id" column="outcrop_id" />
			<result property="name" column="outcrop_name" />
			<result property="number" column="outcrop_number" />
		</collection>

		<collection property="shotlines" ofType="Shotline">
			<id property="id" column="shotline_id" />
			<result property="name" column="shotline_name" />
			<result property="alt_names" column="alt_shotline_names" />
			<result property="year" column="shotline_year" />
			<result property="shotline_min" column="shotline_min" />
			<result property="shotline_max" column="shotline_max" />
		</collection>

		<collection property="qualities" ofType="InventoryQuality">
			<id property="id" column="inventory_quality_id" />
			<result property="date" column="quality_check_date" />
			<result property="username" column="quality_username" />
			<result property="remark" column="quality_remark" />
			<result property="issues" column="quality_issues"
				typeHandler="org.apache.ibatis.type.ArrayTypeHandler" />
		</collection>
	</resultMap>


	<select id="getStashByID" parameterType="String" resultSetType="FORWARD_ONLY" resultType="String">
		SELECT stash
		FROM inventory
		WHERE inventory_id = #{inventory_id}
		LIMIT 1
	</select>


	<update id="updateBarcode" parameterType="map">
		UPDATE inventory SET barcode = #{new_barcode}
		WHERE barcode = #{old_barcode}
	</update>


	<update id="updateAltBarcode" parameterType="map">
		UPDATE inventory SET barcode = #{new_barcode}
		WHERE alt_barcode = #{old_barcode}
	</update>


	<update id="moveInventoryByBarcode" parameterType="Map">
		UPDATE inventory SET container_id = #{container_id}
		WHERE barcode = #{barcode}
			OR barcode = ('GMC-' || #{barcode})
			OR alt_barcode = #{barcode}
	</update>


	<insert id="insert" parameterType="Inventory" useGeneratedKeys="true" keyColumn="inventory_id" keyProperty="id">
		INSERT INTO inventory (
			barcode, remark, container_id, keywords
		) VALUES (
			#{barcode}, #{remark}, #{container.id},
			<foreach collection="keywords" item="i" open="ARRAY[" separator="," close="]::keyword[]">#{i}</foreach>
		)

	</insert>


	<insert id="insertStash" parameterType="String">
		INSERT INTO inventory (stash) VALUES (#{stash}::JSONB)
	</insert>


	<update id="update" parameterType="Inventory">
		UPDATE inventory SET
			dggs_sample_id = #{dggs_sample_id},
			lab_report_id = #{lab_report_id},
			sample_number = #{sample_number},
			sample_number_prefix = #{sample_number_prefix},
			alt_sample_number = #{alt_sample_number},
			published_sample_number = #{published_sample_number},
			published_number_has_suffix = #{published_number_has_suffix},
			barcode = #{barcode},
			alt_barcode = #{alt_barcode},
			state_number = #{state_number},
			box_number = #{box_number},
			set_number = #{set_number},
			split_number = #{split_number},
			slide_number = #{slide_number},
			slip_number = #{slip_number},
			lab_number = #{lab_number},
			map_number = #{map_number},
			description = #{description},
			remark = #{remark},
			tray = #{tray},
			interval_top = #{intervalTop},
			interval_bottom = #{intervalBottom},
			core_number = #{core_number},
			weight = #{weight},
			sample_frequency = #{sample_frequency},
			recovery = #{recovery},
			can_publish = #{can_publish},
			radiation_msvh = #{radiation_msvh},
			received_date = #{received},
			entered_date = #{entered},
			modified_user = #{user},
			active = #{active}
		WHERE inventory_id = #{id}
	</update>
</mapper>
